from argh import arg, wrap_errors
import socket
from . import util
import subprocess

@arg('gateway_pub_key', help='public key of the gateway')
@arg('client_ip', help='client tunnel ip')
@arg('gateway_ip', help='gateway tunnel ip')
@wrap_errors([socket.error, IOError])
def setgateway(gateway_pub_key, client_ip, gateway_ip):
    'initiate the gateway configuration'
    subprocess.run(["uci", "set", "system.gateway=gateway"])
    subprocess.run(["uci", "set", "system.gateway.key=" + gateway_pub_key])
    subprocess.run(["uci", "set", "system.gateway.cl_ip=" + client_ip])
    subprocess.run(["uci", "set", "system.gateway.gw_ip=" + gateway_ip])
    subprocess.run(["uci", "commit"])
    util.client_provision()

@wrap_errors([socket.error, IOError])
def provision():
    'provision the gateway configuration using saved settings'
    util.client_provision()

cmd = [setgateway, provision]
